"use strict";var Je=Object.create;var I=Object.defineProperty,De=Object.defineProperties,Ye=Object.getOwnPropertyDescriptor,Fe=Object.getOwnPropertyDescriptors,ze=Object.getOwnPropertyNames,x=Object.getOwnPropertySymbols,Be=Object.getPrototypeOf,D=Object.prototype.hasOwnProperty,se=Object.prototype.propertyIsEnumerable;var oe=(r,e)=>{if(e=Symbol[r])return e;throw Error("Symbol."+r+" is not defined")};var ne=(r,e,t)=>e in r?I(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,y=(r,e)=>{for(var t in e||(e={}))D.call(e,t)&&ne(r,t,e[t]);if(x)for(var t of x(e))se.call(e,t)&&ne(r,t,e[t]);return r},A=(r,e)=>De(r,Fe(e));var ae=(r,e)=>{var t={};for(var o in r)D.call(r,o)&&e.indexOf(o)<0&&(t[o]=r[o]);if(r!=null&&x)for(var o of x(r))e.indexOf(o)<0&&se.call(r,o)&&(t[o]=r[o]);return t};var Xe=(r,e)=>{for(var t in e)I(r,t,{get:e[t],enumerable:!0})},ie=(r,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of ze(e))!D.call(r,n)&&n!==t&&I(r,n,{get:()=>e[n],enumerable:!(o=Ye(e,n))||o.enumerable});return r};var $=(r,e,t)=>(t=r!=null?Je(Be(r)):{},ie(e||!r||!r.__esModule?I(t,"default",{value:r,enumerable:!0}):t,r)),He=r=>ie(I({},"__esModule",{value:!0}),r);var l=(r,e,t)=>new Promise((o,n)=>{var s=i=>{try{c(t.next(i))}catch(p){n(p)}},a=i=>{try{c(t.throw(i))}catch(p){n(p)}},c=i=>i.done?o(i.value):Promise.resolve(i.value).then(s,a);c((t=t.apply(r,e)).next())}),C=function(r,e){this[0]=r,this[1]=e},Y=(r,e,t)=>{var o=(a,c,i,p)=>{try{var u=t[a](c),m=(c=u.value)instanceof C,h=u.done;Promise.resolve(m?c[0]:c).then(d=>m?o(a==="return"?a:"next",c[1]?{done:d.done,value:d.value}:d,i,p):i({value:d,done:h})).catch(d=>o("throw",d,i,p))}catch(d){p(d)}},n=a=>s[a]=c=>new Promise((i,p)=>o(a,c,i,p)),s={};return t=t.apply(r,e),s[Symbol.asyncIterator]=()=>s,n("next"),n("throw"),n("return"),s};var F=(r,e,t)=>(e=r[oe("asyncIterator")])?e.call(r):(r=r[oe("iterator")](),e={},t=(o,n)=>(n=r[o])&&(e[o]=s=>new Promise((a,c,i)=>(s=n.call(r,s),i=s.done,Promise.resolve(s.value).then(p=>a({value:p,done:i}),c)))),t("next"),t("return"),e);var gt={};Xe(gt,{PromptLayer:()=>Q});module.exports=He(gt);var ce=$(require("ably"));var w=process.env.URL_API_PROMPTLAYER||"https://api.promptlayer.com",pe=(r,e)=>l(void 0,null,function*(){return e.request_response[Symbol.asyncIterator]!==void 0?Ze(r,e.request_response,e):yield le(r,e)}),le=(r,e)=>l(void 0,null,function*(){try{let t=yield fetch(`${w}/track-request`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),o=yield t.json();if(t.status!==200&&T(o,"WARNING: While logging your request, PromptLayer experienced the following error:"),o&&e.return_pl_id)return[e.request_response,o.request_id]}catch(t){console.warn(`WARNING: While logging your request PromptLayer had the following error: ${t}`)}return e.request_response}),ue=(r,e)=>l(void 0,null,function*(){try{let t=yield fetch(`${w}/library-track-metadata`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(A(y({},e),{api_key:r}))}),o=yield t.json();if(t.status!==200)return T(o,"WARNING: While logging metadata to your request, PromptLayer experienced the following error"),!1}catch(t){return console.warn(`WARNING: While logging metadata to your request, PromptLayer experienced the following error: ${t}`),!1}return!0}),me=(r,e)=>l(void 0,null,function*(){try{let t=yield fetch(`${w}/library-track-score`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(A(y({},e),{api_key:r}))}),o=yield t.json();if(t.status!==200)return T(o,"WARNING: While scoring your request, PromptLayer experienced the following error"),!1}catch(t){return console.warn(`WARNING: While scoring your request, PromptLayer experienced the following error: ${t}`),!1}return!0}),fe=(r,e)=>l(void 0,null,function*(){try{let t=yield fetch(`${w}/library-track-prompt`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(A(y({},e),{api_key:r}))}),o=yield t.json();if(t.status!==200)return T(o,"WARNING: While associating your request with a prompt template, PromptLayer experienced the following error"),!1}catch(t){return console.warn(`WARNING: While associating your request with a prompt template, PromptLayer experienced the following error: ${t}`),!1}return!0}),de=(r,e)=>l(void 0,null,function*(){try{let t=yield fetch(`${w}/track-group`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(A(y({},e),{api_key:r}))}),o=yield t.json();if(t.status!==200)return T(o,"WARNING: While associating your request with a group, PromptLayer experienced the following error"),!1}catch(t){return console.warn(`WARNING: While associating your request with a group, PromptLayer experienced the following error: ${t}`),!1}return!0}),he=r=>l(void 0,null,function*(){try{let e=yield fetch(`${w}/create-group`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({api_key:r})}),t=yield e.json();return e.status!==200?(T(t,"WARNING: While creating a group PromptLayer had the following error"),!1):t.id}catch(e){return console.warn(`WARNING: While creating a group PromptLayer had the following error: ${e}`),!1}}),ye=(r,e,t)=>l(void 0,null,function*(){try{let o=new URL(`${w}/prompt-templates/${e}`),n=yield fetch(o,{method:"POST",headers:{"Content-Type":"application/json","X-API-KEY":r},body:JSON.stringify(t)}),s=yield n.json();return n.status!==200?(T(s,"WARNING: While fetching a prompt template PromptLayer had the following error"),null):(s.warning&&console.warn(`WARNING: While fetching your prompt PromptLayer had the following error: ${s.warning}`),s)}catch(o){return console.warn(`WARNING: While fetching a prompt template PromptLayer had the following error: ${o}`),null}}),ge=(r,e)=>l(void 0,null,function*(){try{let t=yield fetch(`${w}/rest/prompt-templates`,{method:"POST",headers:{"Content-Type":"application/json","X-API-KEY":r},body:JSON.stringify({prompt_template:y({},e),prompt_version:y({},e),release_labels:e.release_labels?e.release_labels:void 0})}),o=yield t.json();return t.status===400&&T(o,"WARNING: While publishing a prompt template PromptLayer had the following error"),o}catch(t){console.warn(`WARNING: While publishing a prompt template PromptLayer had the following error: ${t}`)}}),_e=(r,e)=>l(void 0,null,function*(){var t;try{let o=new URL(`${w}/prompt-templates`);Object.entries(e||{}).forEach(([a,c])=>o.searchParams.append(a,c.toString()));let n=yield fetch(o,{headers:{"Content-Type":"application/json","X-API-KEY":r}}),s=yield n.json();return n.status!==200?(T(s,"WARNING: While fetching all prompt templates PromptLayer had the following error"),null):(t=s.items)!=null?t:[]}catch(o){return console.warn(`WARNING: While fetching all prompt templates PromptLayer had the following error: ${o}`),null}}),we=i=>l(void 0,[i],function*({workflow_name:r,input_variables:e,metadata:t={},workflow_label_name:o=null,workflow_version_number:n=null,return_all_outputs:s=!1,api_key:a,timeout:c=36e5}){let p={input_variables:e,metadata:t,workflow_label_name:o,workflow_version_number:n,return_all_outputs:s},u={"X-API-KEY":a,"Content-Type":"application/json"};try{let m=yield fetch(`${w}/workflows/${encodeURIComponent(r)}/run`,{method:"POST",headers:u,body:JSON.stringify(p)});if(m.status!==201)return{success:!1,message:`Failed to run workflow: ${(yield m.json().catch(()=>({}))).error||m.statusText}`};let h=yield m.json();h.warning&&console.warn(`WARNING: ${h.warning}`);let d=h.workflow_version_execution_id;if(!d)return console.log("No execution ID returned from workflow run"),{success:!1,message:"Failed to run workflow"};let b=`workflow_updates:${d}`,P=(yield(yield fetch(`${w}/ws-token-request-library?capability=${b}`,{method:"POST",headers:u})).json()).token_details.token,g=new ce.default.Realtime({token:P});try{let f=yield Ve(g,b,c);return g.close(),f}finally{g.close()}}catch(m){throw console.error(`Failed to run workflow: ${m instanceof Error?m.message:m}`),m}});function Ve(r,e,t){return l(this,null,function*(){let o=r.channels.get(e);return new Promise((n,s)=>l(this,null,function*(){let a=null,c=p=>{p.name==="SET_WORKFLOW_COMPLETE"&&(a=JSON.parse(p.data).final_output,clearTimeout(i),o.unsubscribe("SET_WORKFLOW_COMPLETE",c),n(a))},i=setTimeout(()=>{o.unsubscribe("SET_WORKFLOW_COMPLETE",c),s(new Error("Workflow execution did not complete properly (timeout)"))},t);try{yield o.subscribe("SET_WORKFLOW_COMPLETE",c)}catch(p){clearTimeout(i),s(p)}}))})}var v=r=>{var c,i,p,u,m,h,d,b,O;let e=null,t,o={id:"",choices:[],created:Date.now(),model:"",object:"chat.completion"},n=r.at(-1);if(!n)return o;let s;for(let _ of r){if(_.choices.length===0)continue;let P=_.choices[0].delta;P.content&&(e=`${e||""}${P.content||""}`),P.function_call&&(t={name:`${t?t.name:""}${P.function_call.name||""}`,arguments:`${t?t.arguments:""}${P.function_call.arguments||""}`});let g=(c=P.tool_calls)==null?void 0:c[0];if(g){s=s||[];let f=s.at(-1);if(!f||g.id){s.push({id:g.id||"",type:g.type||"function",function:{name:((i=g.function)==null?void 0:i.name)||"",arguments:((p=g.function)==null?void 0:p.arguments)||""}});continue}f.function.name=`${f.function.name}${((u=g.function)==null?void 0:u.name)||""}`,f.function.arguments=`${f.function.arguments}${((m=g.function)==null?void 0:m.arguments)||""}`}}let a=r[0].choices.at(0);return o.choices.push({finish_reason:(h=a==null?void 0:a.finish_reason)!=null?h:"stop",index:(d=a==null?void 0:a.index)!=null?d:0,logprobs:(b=a==null?void 0:a.logprobs)!=null?b:null,message:{role:"assistant",content:e,function_call:t||void 0,tool_calls:s||void 0,refusal:(O=a==null?void 0:a.delta.refusal)!=null?O:null}}),o.id=n.id,o.model=n.model,o.created=n.created,o.system_fingerprint=n.system_fingerprint,o.usage=n.usage,o},B=r=>{let e={id:"",model:"",content:[],role:"assistant",type:"message",stop_reason:"stop_sequence",stop_sequence:null,usage:{input_tokens:0,output_tokens:0}};if(!r.at(-1))return e;let o="";for(let n of r)switch(n.type){case"message_start":{e=y({},n.message);break}case"content_block_delta":n.delta.type==="text_delta"&&(o=`${o}${n.delta.text}`);case"message_delta":"usage"in n&&(e.usage.output_tokens=n.usage.output_tokens),"stop_reason"in n.delta&&(e.stop_reason=n.delta.stop_reason);default:break}return e.content.push({type:"text",text:o}),e},Qe=(r,e="openai.chat.completions.create")=>{if("completion"in r[0])return r.reduce((t,o)=>A(y({},o),{completion:`${t.completion}${o.completion}`}),{});if(e==="anthropic.messages.create")return B(r);if("text"in r[0].choices[0]){let t="";for(let n of r)t=`${t}${n.choices[0].text}`;let o=structuredClone(r.at(-1));return o.choices[0].text=t,o}if("delta"in r[0].choices[0]){let t=v(r);return t.choices[0]=y(y({},t.choices[0]),t.choices[0].message),t}return""};function Ze(r,e,t){return Y(this,null,function*(){let o=[];try{for(var a=F(e),c,i,p;c=!(i=yield new C(a.next())).done;c=!1){let u=i.value;yield t.return_pl_id?[u,null]:u,o.push(u)}}catch(i){p=[i]}finally{try{c&&(i=a.return)&&(yield new C(i.call(a)))}finally{if(p)throw p[0]}}let n=Qe(o,t.function_name),s=yield new C(le(r,A(y({},t),{request_response:n,request_end_time:new Date().toISOString()})));if(s&&t.return_pl_id){let u=s[1];yield[o.at(-1),u]}})}var T=(r,e)=>{try{console.warn(`${e}: ${r.message}`)}catch(t){console.warn(`${e}: ${r}`)}},Pe=r=>l(void 0,null,function*(){try{let e=yield fetch(`${w}/track-request`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});return e.status!==200&&T(e,"WARNING: While logging your request, PromptLayer experienced the following error:"),e.json()}catch(e){console.warn(`WARNING: While logging your request PromptLayer had the following error: ${e}`)}return{}}),X=r=>{let e={id:"",choices:[{finish_reason:"stop",index:0,text:"",logprobs:null}],created:Date.now(),model:"",object:"text_completion"},t=r.at(-1);if(!t)return e;let o="";for(let n of r)n.choices.length>0&&n.choices[0].text&&(o=`${o}${n.choices[0].text}`);return e.choices[0].text=o,e.id=t.id,e.created=t.created,e.model=t.model,e.system_fingerprint=t.system_fingerprint,e.usage=t.usage,e},Re=r=>{let e={completion:"",id:"",model:"",stop_reason:"",type:"completion"},t=r.at(-1);if(!t)return e;let o="";for(let n of r)o=`${o}${n.completion}`;return e.completion=o,e.id=t.id,e.model=t.model,e.stop_reason=t.stop_reason,e};function Te(r,e,t){return Y(this,null,function*(){let o={request_id:null,raw_response:null,prompt_blueprint:null},n=[];try{for(var c=F(r),i,p,u;i=!(p=yield new C(c.next())).done;i=!1){let m=p.value;n.push(m),o.raw_response=m,yield o}}catch(p){u=[p]}finally{try{i&&(p=c.return)&&(yield new C(p.call(c)))}finally{if(u)throw u[0]}}let s=t(n),a=yield new C(e({request_response:s}));o.request_id=a.request_id,o.prompt_blueprint=a.prompt_blueprint,yield o})}var et=(r,e)=>l(void 0,null,function*(){return r.chat.completions.create(e)}),tt=(r,e)=>l(void 0,null,function*(){return r.completions.create(e)}),Se={chat:et,completion:tt},be=(r,e)=>l(void 0,null,function*(){let t=require("openai").default,o=new t({baseURL:e.baseURL}),n=Se[r.prompt_template.type];return n(o,e)}),Oe=(r,e)=>l(void 0,null,function*(){let t=require("openai").AzureOpenAI,o=new t({endpoint:e.baseURL});e==null||delete e.baseURL;let n=Se[r.prompt_template.type];return n(o,e)}),rt=(r,e)=>l(void 0,null,function*(){return r.messages.create(e)}),ot=(r,e)=>l(void 0,null,function*(){return r.completions.create(e)}),nt={chat:rt,completion:ot},Ae=(r,e)=>l(void 0,null,function*(){let t=require("@anthropic-ai/sdk").default,o=new t({baseURL:e.baseURL}),n=nt[r.prompt_template.type];return n(o,e)}),Ce=(r,e)=>l(void 0,null,function*(){try{let t=yield fetch(`${w}/log-request`,{method:"POST",headers:{"X-API-KEY":r,"Content-Type":"application/json"},body:JSON.stringify(e)});return t.status!==201?(T(t,"WARNING: While logging your request PromptLayer had the following error"),null):t.json()}catch(t){return console.warn(`WARNING: While tracking your prompt PromptLayer had the following error: ${t}`),null}}),ke=r=>{var o,n,s,a,c,i,p,u,m,h;if(!r.length)return{candidates:[{index:0,content:{parts:[{text:""}],role:""},finishReason:void 0}],usageMetadata:void 0};let e="";for(let d of r)e+=(i=(c=(a=(s=(n=(o=d.candidates)==null?void 0:o[0])==null?void 0:n.content)==null?void 0:s.parts)==null?void 0:a[0])==null?void 0:c.text)!=null?i:"";let t=y({},r[r.length-1]);return(h=(m=(u=(p=t.candidates)==null?void 0:p[0])==null?void 0:u.content)==null?void 0:m.parts)!=null&&h[0]&&(t.candidates[0].content.parts[0].text=e),t},Ne=r=>ke(r),Ee=r=>ke(r),st=(r,e)=>l(void 0,null,function*(){var a;let t=e==null?void 0:e.history,o=e==null?void 0:e.generationConfig,n=t.length>0?t[t.length-1]:"",s=r.startChat({history:(a=t.slice(0,-1))!=null?a:[]});return e!=null&&e.stream?(yield s.sendMessageStream(n.parts,{generationConfig:o})).stream:yield s.sendMessage(n.parts,{generationConfig:o})}),at=(r,o)=>l(void 0,null,function*(){var n=o,{stream:e}=n,t=ae(n,["stream"]);return e?(yield r.generateContentStream(y({},t))).stream:yield r.generateContent(y({},t))}),it={chat:st,completion:at},Ie=(r,e)=>l(void 0,null,function*(){var c;let{GoogleGenerativeAI:t}=require("@google/generative-ai"),o=new t(process.env.GOOGLE_API_KEY),n=it[r.prompt_template.type],s=z(e),a=o.getGenerativeModel({model:(c=s.model)!=null?c:"gemini-1.5-pro",systemInstruction:s==null?void 0:s.systemInstruction});return yield n(a,s)}),ct=r=>r.replace(/_([a-z])/g,(e,t)=>t.toUpperCase()),z=r=>!r||typeof r!="object"?r:Array.isArray(r)?r.map(z):Object.fromEntries(Object.entries(r).map(([e,t])=>[ct(e),z(t)]));var G=class{constructor(e){this.create=()=>he(this.apiKey);this.apiKey=e}};var Le=$(require("@opentelemetry/api")),We=require("@opentelemetry/sdk-trace-base"),xe=require("@opentelemetry/sdk-trace-node");var S=require("@opentelemetry/api"),q=require("@opentelemetry/core");var H=class{constructor(e,t){this.apiKey=t||process.env.PROMPTLAYER_API_KEY,this.enableTracing=e,this.url=`${w}/spans-bulk`}attributesToObject(e){return e?Object.fromEntries(Object.entries(e)):{}}spanKindToString(e){return{[S.SpanKind.INTERNAL]:"SpanKind.INTERNAL",[S.SpanKind.SERVER]:"SpanKind.SERVER",[S.SpanKind.CLIENT]:"SpanKind.CLIENT",[S.SpanKind.PRODUCER]:"SpanKind.PRODUCER",[S.SpanKind.CONSUMER]:"SpanKind.CONSUMER"}[e]||"SpanKind.INTERNAL"}statusCodeToString(e){return{[S.SpanStatusCode.ERROR]:"StatusCode.ERROR",[S.SpanStatusCode.OK]:"StatusCode.OK",[S.SpanStatusCode.UNSET]:"StatusCode.UNSET"}[e]||"StatusCode.UNSET"}toNanoseconds(e){return(BigInt(e[0])*BigInt(1e9)+BigInt(e[1])).toString()}export(e){if(!this.enableTracing)return Promise.resolve(q.ExportResultCode.SUCCESS);let t=e.map(o=>{var n;return{name:o.name,context:{trace_id:o.spanContext().traceId,span_id:o.spanContext().spanId,trace_state:((n=o.spanContext().traceState)==null?void 0:n.serialize())||""},kind:this.spanKindToString(o.kind),parent_id:o.parentSpanId||null,start_time:this.toNanoseconds(o.startTime),end_time:this.toNanoseconds(o.endTime),status:{status_code:this.statusCodeToString(o.status.code),description:o.status.message},attributes:this.attributesToObject(o.attributes),events:o.events.map(s=>({name:s.name,timestamp:this.toNanoseconds(s.time),attributes:this.attributesToObject(s.attributes)})),links:o.links.map(s=>({context:s.context,attributes:this.attributesToObject(s.attributes)})),resource:{attributes:A(y({},o.resource.attributes),{"service.name":"prompt-layer-js"}),schema_url:""}}});return fetch(this.url,{method:"POST",headers:{"Content-Type":"application/json","X-API-KEY":this.apiKey||""},body:JSON.stringify({spans:t})}).then(o=>o.ok?q.ExportResultCode.SUCCESS:(console.error(`Error exporting spans
HTTP error! status: ${o.status}`),q.ExportResultCode.FAILED)).catch(o=>(console.error("Error exporting spans:",o),q.ExportResultCode.FAILED))}shutdown(){return Promise.resolve()}},qe=H;var E=(r="promptlayer-tracer")=>Le.trace.getTracer(r),$e=(r,e)=>{let t=new xe.NodeTracerProvider,o=new qe(r,e),n=new We.SimpleSpanProcessor(o);t.addSpanProcessor(n),t.register()};var pt=E(),V=(r,e,t="",o="openai")=>{let n={construct:(s,a)=>{let c=Reflect.construct(s,a);return Object.defineProperties(c,{function_name:{value:t,writable:!0},provider:{value:o}}),new Proxy(c,n)},get:(s,a,c)=>{let i=s[a],p=`${Reflect.get(s,"function_name")}.${a.toString()}`;return typeof i=="object"?(Object.defineProperties(i,{function_name:{value:p,writable:!0},provider:{value:o}}),new Proxy(i,n)):typeof i=="function"?(...u)=>{var O,_,P,g;let m=new Date().toISOString(),h=Reflect.get(s,"provider"),d=(O=u[0])==null?void 0:O.return_pl_id,b=(_=u[0])==null?void 0:_.pl_tags;return(P=u[0])==null||delete P.return_pl_id,(g=u[0])==null||delete g.pl_tags,pt.startActiveSpan(`${h}.${p}`,f=>l(void 0,null,function*(){try{f.setAttribute("function_input",JSON.stringify(u));let R=Reflect.apply(i,s,u),U=f.spanContext().spanId;return R instanceof Promise?new Promise((k,L)=>{R.then(N=>l(void 0,null,function*(){let W=yield pe(r,{api_key:r,provider_type:h,function_name:p,request_start_time:m,request_end_time:new Date().toISOString(),request_response:N,kwargs:u[0],return_pl_id:d,tags:b,span_id:U});f.setAttribute("function_output",JSON.stringify(W)),f.setAttribute("response_status","success"),f.end(),k(W)})).catch(N=>{f.recordException(N),f.setAttribute("response_status","error"),f.end(),L(N)})}):(f.setAttribute("function_output",JSON.stringify(R)),f.setAttribute("response_status","success"),f.end(),R)}catch(R){throw f.recordException(R),f.setAttribute("response_status","error"),f.end(),R}}))}:Reflect.get(s,a,c)}};return new Proxy(e,n)};var M=$(require("@opentelemetry/api"));var Ge=(r,e,t)=>function(...o){let n=E(),s=a=>{try{t&&Object.entries(t).forEach(([i,p])=>{a.setAttribute(i,p)}),a.setAttribute("function_input",JSON.stringify(o));let c=e(...o);return c instanceof Promise?c.then(i=>(a.setAttribute("function_output",JSON.stringify(i)),a.setStatus({code:M.SpanStatusCode.OK}),i)).catch(i=>{throw ve(a,i,o),i}).finally(()=>a.end()):(a.setAttribute("function_output",JSON.stringify(c)),a.setStatus({code:M.SpanStatusCode.OK}),a.end(),c)}catch(c){throw ve(a,c,o),c}};return n.startActiveSpan(r,s)},ve=(r,e,t)=>{r.setAttribute("function_input",JSON.stringify(t)),r.setStatus({code:M.SpanStatusCode.ERROR,message:e instanceof Error?e.message:"Unknown error"}),r.end()};var K=class{constructor(e){this.get=(e,t)=>ye(this.apiKey,e,t);this.publish=e=>ge(this.apiKey,e);this.all=e=>_e(this.apiKey,e);this.apiKey=e}};var lt=(r,e)=>{if(!(e.metadata instanceof Object))throw new Error("Please provide a dictionary of metadata.");for(let[t,o]of Object.entries(e.metadata))if(typeof t!="string"||typeof o!="string")throw new Error("Please provide a dictionary of metadata with key value pair of strings.");return ue(r,e)},ut=(r,e)=>{if(typeof e.score!="number")throw new Error("Score must be a number");if(e.score<0||e.score>100)throw new Error("Score must be a number between 0 and 100.");return me(r,e)},mt=(r,e)=>{if(!(e.prompt_input_variables instanceof Object))throw new Error("Prompt template input variable dictionary not provided.");return fe(r,e)},ft=(r,e)=>de(r,e),j=class{constructor(e){this.group=e=>ft(this.apiKey,e);this.metadata=e=>lt(this.apiKey,e);this.prompt=e=>mt(this.apiKey,e);this.score=e=>ut(this.apiKey,e);this.apiKey=e}};var Me=$(require("@opentelemetry/api"));var dt={openai:{chat:{function_name:"openai.chat.completions.create",stream_function:v},completion:{function_name:"openai.completions.create",stream_function:X}},anthropic:{chat:{function_name:"anthropic.messages.create",stream_function:B},completion:{function_name:"anthropic.completions.create",stream_function:Re}},"openai.azure":{chat:{function_name:"openai.AzureOpenAI.chat.completions.create",stream_function:v},completion:{function_name:"openai.AzureOpenAI.completions.create",stream_function:X}},google:{chat:{function_name:"google.convo.send_message",stream_function:Ne},completion:{function_name:"google.model.generate_content",stream_function:Ee}}},ht={openai:be,anthropic:Ae,"openai.azure":Oe,google:Ie},yt=r=>{if(!r||typeof r!="object"||Array.isArray(r))return!1;let e=["status","value","error_message","raw_error_message","is_output_node"];return Object.values(r).every(o=>typeof o!="object"||o===null?!1:e.every(n=>n in o))},Q=class{constructor({apiKey:e=process.env.PROMPTLAYER_API_KEY,enableTracing:t=!1}={}){if(e===void 0)throw new Error("PromptLayer API key not provided. Please set the PROMPTLAYER_API_KEY environment variable or pass the api_key parameter.");this.apiKey=e,this.enableTracing=t,this.templates=new K(e),this.group=new G(e),this.track=new j(e),this.wrapWithSpan=Ge,t&&$e(t,e)}get Anthropic(){try{let e=require("@anthropic-ai/sdk").default;return V(this.apiKey,e,"anthropic","anthropic")}catch(e){console.error("To use the Anthropic module, you must install the @anthropic-ai/sdk package.")}}get OpenAI(){try{let e=require("openai").default;return V(this.apiKey,e,"openai","openai")}catch(e){console.error("To use the OpenAI module, you must install the @openai/api package.")}}run(u){return l(this,arguments,function*({promptName:e,promptVersion:t,promptReleaseLabel:o,inputVariables:n,tags:s,metadata:a,groupId:c,modelParameterOverrides:i,stream:p=!1}){return E().startActiveSpan("PromptLayer Run",h=>l(this,null,function*(){try{let d={promptName:e,promptVersion:t,promptReleaseLabel:o,inputVariables:n,tags:s,metadata:a,groupId:c,modelParameterOverrides:i,stream:p};h.setAttribute("function_input",JSON.stringify(d));let b=n,O={label:o,version:t,metadata_filters:a};n&&(O.input_variables=n);let _=yield this.templates.get(e,O);if(!_)throw new Error("Prompt not found");let P=_.prompt_template;if(!_.llm_kwargs)throw new Error(`Prompt '${e}' does not have any LLM kwargs associated with it. Please set your model parameters in the registry in the PromptLayer dashbaord.`);let g=_.metadata;if(!g)throw new Error(`Prompt '${e}' does not have any metadata associated with it.`);let f=g.model;if(!f)throw new Error(`Prompt '${e}' does not have a model parameters associated with it.`);let R=f.provider,U=new Date().toISOString(),k=y(y({},_.llm_kwargs),i||{}),L=dt[R][P.type],N=L.function_name,W=L.stream_function,Ke=ht[R],Z=_.provider_base_url;Z&&(k.baseURL=Z.url),k.stream=p,p&&["openai","openai.azure"].includes(R)&&(k.stream_options={include_usage:!0});let J=yield Ke(_,k),ee=je=>{let Ue=new Date().toISOString();return Pe(y({function_name:N,provider_type:R,args:[],kwargs:k,tags:s,request_start_time:U,request_end_time:Ue,api_key:this.apiKey,metadata:a,prompt_id:_.id,prompt_version:_.version,prompt_input_variables:b,group_id:c,return_prompt_blueprint:!0,span_id:h.spanContext().spanId},je))};if(p)return Te(J,ee,W);let te=yield ee({request_response:J}),re={request_id:te.request_id,raw_response:J,prompt_blueprint:te.prompt_blueprint};return h.setAttribute("function_output",JSON.stringify(re)),re}catch(d){throw h.setStatus({code:Me.SpanStatusCode.ERROR,message:d instanceof Error?d.message:"Unknown error"}),d}finally{h.end()}}))})}runWorkflow(c){return l(this,arguments,function*({workflowName:e,inputVariables:t={},metadata:o={},workflowLabelName:n=null,workflowVersion:s=null,returnAllOutputs:a=!1}){try{let i=yield we({workflow_name:e,input_variables:t,metadata:o,workflow_label_name:n,workflow_version_number:s,return_all_outputs:a,api_key:this.apiKey});if(!a&&yt(i)){let u=Object.values(i).filter(h=>h.is_output_node===!0);if(u.length===0)throw new Error(JSON.stringify(i,null,2));if(!u.some(h=>h.status==="SUCCESS"))throw new Error(JSON.stringify(i,null,2))}return i}catch(i){throw i instanceof Error?(console.error("Error running workflow:",i.message),new Error(`Error running workflow: ${i.message}`)):(console.error("Unknown error running workflow:",i),new Error("Unknown error running workflow"))}})}logRequest(e){return l(this,null,function*(){return Ce(this.apiKey,e)})}};0&&(module.exports={PromptLayer});
//# sourceMappingURL=index.js.map